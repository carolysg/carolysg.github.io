<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>Projeto - API HG Weather</title>
	<!-- Google Font -->
	<link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700|Source+Sans+Pro:400,700" rel="stylesheet">
	<!-- Font Awesome Icons -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
	<!-- Main CSS -->
	<link href="./assets/css/main2.css" rel="stylesheet"/>
</head>
<body>   
<!--------------------------------------
HEADER
--------------------------------------->
<div class="container">
	<div class="jumbotron jumbotron-fluid mb-3 pl-0 pt-0 pb-0 bg-white position-relative">
		<div class="h-100 tofront">
			<div class="row justify-content-between">
				<div class="col-md-6 pt-6 pb-6 pr-6 align-self-center">
					<h1>Coleta de dados via API HG Weather utilizando GCP</h1>
					<a small href="https://github.com/carolysg/api-weather/tree/main" target="_blank">Link do repositório do Github</a> <br>
					<a small href="https://hgbrasil.com/status/weather" target="_blank">Link do site da API</a>
				</div>
				<div class="col-md-6 pr-0">
					<img src="images/projeto05.jpg">
				</div>
			</div>
		</div>
	</div>
</div>
<!-- End Header -->
    
<!--------------------------------------
MAIN
--------------------------------------->
<div class="container pt-4 pb-4">
	<div class="row justify-content-center">
		<article class="article-post">
			<div>
				<h2>Sobre o projeto</h2>
			</div>
			<br>
			<p>
				Este projeto foi inteiramente realizado na Google Cloud Plataform (GCP) e consiste das seguintes etapas:
				<ul>
					<li>Coleta de dados do clima da cidade de São Carlos (dados atuais e de previsão) utilizando a API HG Weather.</li>
					<li>Tratamento de dados da camada bronze para a silver.</li>
					<li>Upload dos dados no BigQuery.</li>
				</ul>
			</p>
			<p>
				A arquitetura do projeto é apresentada no fluxograma abaixo:
			</p>
			<img src="images\projetos\05_01.png">
			<p>
				Vale ressaltar que, como o projeto foi realizado de forma totalmente gratuita (utilizando o período de teste de 90 dias da GCP), as cloud functions permaneceram rodando apenas entre o período de 15/10/2023 a 14/01/2024.
			</p>
			<br>
			<br>
			<div>
				<h2>Etapas iniciais</h2>
			</div>
			<br>
			<p>
				O primeiro passo do projeto foi entender o funcionamento da API HG Weather, a qual seria utilizada para coletar os dados do clima da cidade de São Carlos.
				A partir da documentação foi possível verificar que cada cidade possui um código WOEID e que esse tipo de consulta não necessitava de chave da API.
				Foi necessário apenas buscar pela cidade requerida e, então, o link para utilização da API foi gerado automaticamente.
			</p>
			<img src="images\projetos\05_02.png">
			<p>
				Ao fazer uma requisição utilizando o link da API, um JSON é retornado com dois tipos de informações:
				<ul>
					<li>Dados sobre o clima atual: data, horário, temperatura, descrição do tempo, umidade, velocidade do vento, entre outras informações.</li>
					<li>Dados da previsão do tempo dos próximos 9 dias: data, dia da semana, temperaturas máxima e mínima, probabilidade de chuva, entre outras.</li>
				</ul>
			</p>
			<p>
				Um exemplo de arquivo JSON obtido pode ser visualizado neste link: <a small href="https://github.com/carolysg/api-weather/blob/main/sao-carlos-2023-10-15-15-30.json" target="_blank">arquivo.json</a><br>
				Dessa forma, após entender o formato dos dados, iniciou-se a etapa de extração.
			</p>
			<br>
			<br>
			<div>
				<h2>Extração e ingestão dos dados</h2>
			</div>
			<br>
			<p>
				A cloud function <code>get_sao_carlos_weather</code>, escrita em Python, foi responsável por fazer a requisição dos dados e salvar o arquivo JSON no bucket <code>dados-api</code> dentro da pasta <code>bronze</code>.
				Esta function era ativada uma vez ao dia, por meio de um cloud scheduler. Para cada dia, a function salvava o arquivo JSON com a respectiva data.
			</p>
			<img src="images\projetos\05_03.png">
			<br>
			<br>
			<div>
				<h2>Processamento dos dados</h2>
			</div>
			<br>
			<p>
				A arquitetura do projeto é toda baseada em eventos. Assim que um arquivo era carregado na pasta <code>bronze</code>, um tópico Pub/Sub era ativado e triggava a próxima cloud function. <br>
				Todas as transformações necessárias foram realizadas pela cloud function <code>process_sao_carlos_weather</code>. 
				Essa function realizava, antes de tudo, a verificação do objeto que foi salvo no bucket.
				Caso o objeto tivesse o prefixo correto, o processamento dos dados era iniciado.
			</p>
			<img src="images\projetos\05_04.png">
			<p>
				Inicialmente, as informações contidas no arquivo JSON foram divididas em dois dataframes, um para os dados sobre o clima atual e outro para os dados de previsão. 
				Foram selecionadas apenas algumas das informações presentes no arquivo JSON (aquelas consideradas as mais relevantes).
			</p>
			<img src="images\projetos\05_05.png">
			<p>
				As transformações realizadas foram:
				<ul>
					<li>Para a coluna <code>wind_speedy</code>, foram extraídos apenas os valores numéricos da velocidade do vento, removendo os caracteres indicando <code>km/h</code>.</li>
					<li>Os tipos das colunas foram alterados de forma a facilitar a posterior manipulação desses dados.</li>
					<li>A coluna <code>date</code> do dataframe de previsão foi formatada corretamente.</li>
					<li>As colunas <code>date</code> e <code>time</code> do dataframe de clima atual foram mescladas em uma única coluna <code>datetime</code> e depois dropadas.</li>
				</ul>
			</p>
			<img src="images\projetos\05_06.png">
			<p>
				Após realizar todas essas transformações, os dataframes foram salvos em arquivos CSV distintos, um para os dados sobre o clima atual e outro para os dados de previsão.
				Esses arquivos foram salvos na pasta <code>silver</code> do mesmo bucket, separados nas pastas <code>forecast</code> e <code>real</code>.
			</p>
			<img src="images\projetos\05_07.png">
			<br>
			<br>
			<div>
				<h2>Upload dos dados no BigQuery</h2>
			</div>
			<br>
			<p>
				Da mesma forma que para a cloud function de processamento dos dados, as cloud functions para upload dos dados no BigQuery eram ativadas assim que um arquivo fosse carregado nas respectivas pastas.
				As functions <code>upload_forecast_sao_carlos_weather</code> e <code>upload_real_sao_carlos_weather</code> iniciavam da mesma maneira que a function anterior: 
				realizando a verificação do objeto que foi salvo no bucket. Caso o objeto tivesse o prefixo correto, o upload dos dados no BigQuery era iniciado.
			</p>
			<p>
				Ambas as tabelas no BigQuery, <code>tempo_real</code> e <code>tempo_forecast</code>, foram criadas já com o schema predefinido. 
				Além disso, foram criadas com a configuração de <code>WRITE_APPEND</code>, de forma que os dados fossem sempre acrescentados ao final da tabela em questão.
				Dessa forma, as tabelas nunca seriam substituídas, mas sempre acrescidas de uma ou mais linhas por dia.
			</p>
			<img src="images\projetos\05_08.png">
			<img src="images\projetos\05_09.png">
			<br>
			<br>
			<div>
				<h2>Tabelas no BigQuery</h2>
			</div>
			<br>
			<p>
				Por fim, as tabelas <code>tempo_real</code> e <code>tempo_forecast</code> foram criada no BigQuery e populadas com os dados obtidos pela API.
			</p>
			<p>
				Tabela <code>tempo_real</code>:
			</p>
			<img src="images\projetos\05_11.png">
			<p>
				Tabela <code>tempo_forecast</code>:
			</p>
			<img src="images\projetos\05_10.png">
			<p>
				Dessa forma, consultas utilizando a linguagem SQL podem ser feitas para analisar os dados obtidos.
			</p>
			<img src="images\projetos\05_12.png">
		</article>
	</div>
</div>
<!-- End Main -->
    
<!--------------------------------------
FOOTER
--------------------------------------->
<div class="container mt-5">
	<footer class="bg-white border-top p-3 text-muted small">
	<div class="row align-items-center justify-content-between">
		<div>
			<span class="navbar-brand mr-2"><strong>Mundana</strong></span> Copyright &copy;
			<script>document.write(new Date().getFullYear())</script>
			 . All rights reserved.
		</div>
		<div>
			 Made with <a target="_blank" class="text-secondary font-weight-bold" href="https://www.wowthemes.net/mundana-free-html-bootstrap-template/">Mundana Theme</a> by WowThemes.net.
		</div>
	</div>
	</footer>
</div>
<!-- End Footer -->
    
<!--------------------------------------
JAVASCRIPTS
--------------------------------------->
<script src="./assets/js/vendor/jquery.min.js" type="text/javascript"></script>
<script src="./assets/js/vendor/popper.min.js" type="text/javascript"></script>
<script src="./assets/js/vendor/bootstrap.min.js" type="text/javascript"></script>
<script src="./assets/js/functions.js" type="text/javascript"></script>
</body>
</html>